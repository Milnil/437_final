<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raspberry Pi MJPEG + PCM Audio (Worklet)</title>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            background: #f0f0f0;
            margin: 0;
            padding: 0;
        }

        header {
            background: #333;
            color: #fff;
            padding: 10px;
        }

        h1 {
            margin: 20px 0;
        }

        #video {
            margin-top: 20px;
            border: 2px solid #333;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        #controls {
            margin: 20px;
        }

        #muteButton {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        #instructions {
            max-width: 600px;
            margin: 40px auto;
            text-align: left;
            background: #fff;
            padding: 20px;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <header>
        <h2>Raspberry Pi Streaming</h2>
    </header>

    <h1>Live Video and Audio</h1>
    <img id="video" src="/video" alt="Video Stream" width="320" height="240" />

    <div id="controls">
        <h3>Audio Controls</h3>
        <button id="muteButton">Mute</button>
    </div>

    <div id="instructions">
        <h2>Notes:</h2>
        <p>If you see an error related to AudioWorklet, ensure you are on a supported browser and accessing the page via
            HTTP/HTTPS (not a file URL), and preferably using Chrome or a modern browser. Localhost or HTTPS is required
            for AudioWorklets.</p>
    </div>

    <script>
        const sampleRate = 16000;
        const channels = 1;
        const bytesPerSample = 2; // 16-bit PCM
        let audioContext;
        let workletNode;
        let muted = false;

        const muteButton = document.getElementById('muteButton');
        muteButton.addEventListener('click', () => {
            muted = !muted;
            muteButton.textContent = muted ? 'Unmute' : 'Mute';
            if (workletNode) {
                workletNode.port.postMessage({ type: 'mute', value: muted });
            }
        });

        async function startAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate });
            }

            if (!audioContext.audioWorklet) {
                console.error("AudioWorklet is not supported in this browser or context.");
                return;
            }

            try {
                await audioContext.audioWorklet.addModule('worklet.js');
            } catch (e) {
                console.error("Failed to load worklet module:", e);
                return;
            }

            workletNode = new AudioWorkletNode(audioContext, 'pcm-player');
            workletNode.connect(audioContext.destination);

            // Send initial mute state
            workletNode.port.postMessage({ type: 'mute', value: muted });

            const response = await fetch('/audio');
            if (!response.ok) {
                console.error('Failed to fetch audio stream');
                return;
            }

            const reader = response.body.getReader();

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                if (value) {
                    const dataView = new DataView(value.buffer);
                    const floatData = new Float32Array(value.length / 2);
                    for (let i = 0; i < floatData.length; i++) {
                        let sample = dataView.getInt16(i * 2, true);
                        floatData[i] = sample / 32768.0;
                    }

                    workletNode.port.postMessage({ type: 'audio', samples: floatData });
                }
            }
        }

        document.addEventListener('click', () => {
            if (!audioContext || audioContext.state !== 'running') {
                startAudio();
            }
        }, { once: true });
    </script>
</body>

</html>